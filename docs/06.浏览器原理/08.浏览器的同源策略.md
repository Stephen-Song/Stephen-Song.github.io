---
title: æµè§ˆå™¨çš„åŒæºç­–ç•¥
date: 2021-12-13 21:14:23
permalink: /pages/25740e/
---

# æµè§ˆå™¨çš„åŒæºç­–ç•¥

## ä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯åŒæºç­–ç•¥

åŒæºç­–ç•¥é™åˆ¶äº†ä»åŒä¸€ä¸ªæºåŠ è½½çš„æ–‡æ¡£æˆ–è„šæœ¬å¦‚ä½•ä¸å¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ã€‚è¿™æ˜¯æµè§ˆå™¨çš„ä¸€ä¸ªç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„é‡è¦çš„å®‰å…¨æœºåˆ¶ã€‚åŒæºæŒ‡çš„æ˜¯ï¼š**åè®®**ã€**ç«¯å£å·**ã€**åŸŸå**å¿…é¡»ä¸€è‡´

åŒæºç­–ç•¥ä¸»è¦é™åˆ¶äº†

- å½“å‰åŸŸä¸‹çš„`js`ä¸èƒ½è®¿é—®åˆ°å…¶ä»–åŸŸä¸‹çš„`cookies`ã€`localstorage`å’Œ`indexDB`
- å½“å‰åŸŸä¸èƒ½æ“ä½œå’Œè®¿é—®å…¶ä»–åŸŸä¸‹çš„`DOM`

- å½“å‰åŸŸä¸‹çš„`ajax`æ— æ³•å‘é€è·¨åŸŸè¯·æ±‚

åŒæºç­–ç•¥ä¸»è¦æ˜¯ä¿è¯ç”¨æˆ·çš„ä¿¡æ¯å®‰å…¨ï¼Œåªæ˜¯å¯¹`js`è„šæœ¬çš„ä¸€ç§é™åˆ¶ï¼Œå¹¶ä¸æ˜¯å¯¹æµè§ˆå™¨çš„é™åˆ¶ï¼Œå¯¹äºä¸€èˆ¬çš„`img`éƒ½ä¸ä¼šæœ‰è·¨åŸŸçš„é™åˆ¶ï¼Œå› ä¸ºè¿™äº›éƒ½ä¸ä¼šå‡ºç°å®‰å…¨é—®é¢˜

::: warning å€¼å¾—æ³¨æ„çš„æ˜¯

`<script>`é‡Œé¢çš„srcæŒ‡å‘çš„è¯·æ±‚é“¾æ¥ä¹Ÿä¸ä¼šğŸˆ¶ï¸è·¨åŸŸçš„é™åˆ¶ï¼Œ[å‚è€ƒJSONPçš„å®ç°](/pages/25740e/#jsonp)

:::

## å¦‚ä½•è§£å†³è·¨åŸŸé—®é¢˜

- `CORS`

::: theorem æ¦‚å¿µ

è·¨åŸŸèµ„æºå…±äº«(`CORS`) æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå®ƒä½¿ç”¨é¢å¤–çš„ `HTTP` å¤´æ¥å‘Šè¯‰æµè§ˆå™¨  è®©è¿è¡Œåœ¨ä¸€ä¸ª `origin` (`domain`)ä¸Šçš„`Web`åº”ç”¨è¢«å‡†è®¸è®¿é—®æ¥è‡ªä¸åŒæºæœåŠ¡å™¨ä¸Šçš„æŒ‡å®šçš„èµ„æº

::: right 

[æ¥è‡ªMDN](https://developer.mozilla.org/en-US/docs/Glossary/CORS)

::: 

ç®€å•åœ°æ¥è¯´å°±æ˜¯åªè¦æœåŠ¡å™¨ç«¯å®ç°äº†`cors`è¯·æ±‚å°±å¯ä»¥è·¨æºé€šä¿¡äº†

æµè§ˆå™¨å°†`cors`åˆ†ä¸ºç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚



ç®€å•è¯·æ±‚ä¸ä¼šè§¦å‘`cors`é¢„æ£€è¯·æ±‚

`HTTP`è¯·æ±‚æ–¹æ³•æ˜¯`HEAD` `GET` `POST`

`HTTP`è¯·æ±‚å¤´ä¿¡æ¯ä¸è¶…è¿‡ä»¥ä¸‹çš„å­—æ®µ`Accept`ã€`Accept-Language`ã€`Content-Language`ã€`Last-Event-ID`ã€`Content-Type`ï¼šåªé™äºä¸‰ä¸ªå€¼`application/x-www-form-urlencoded`ã€`multipart/form-data`ã€`text/plain`

::: warning å€¼å¾—æ³¨æ„çš„æ˜¯

æ¯”è¾ƒå¸¸è§çš„`json`å°±ä¸æ˜¯ç®€å•è¯·æ±‚äº†

:::

## ç®€è¿°ä¸€ä¸‹ç®€å•è¯·æ±‚çš„è¿‡ç¨‹

æµè§ˆå™¨ä¼šç›´æ¥å‘å‡º`CORS`è¯·æ±‚ï¼Œä»–ä¼šåœ¨ä»–ä¼šåœ¨è¯·æ±‚çš„å¤´ä¿¡æ¯ä¸Šå¢åŠ ä¸€ä¸ª`Origin`å­—æ®µï¼Œè¯¥å­—æ®µç”¨æ¥è¯´æ˜æœ¬æ¬¡è¯·æ±‚æ¥è‡ªäºå“ªä¸€ä¸ªæºï¼ˆ**åè®®+ç«¯å£+åŸŸå**ï¼‰ï¼Œå¦‚æœ`origin`æŒ‡å®šçš„åŸŸååœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨è¿”å›çš„å“åº”ä¼šå¤šå‡ºä»¥ä¸‹ä¿¡æ¯

```javascript
Access-Control-Allow-Origin: http://api.bob.com  // å’ŒOrignä¸€ç›´
Access-Control-Allow-Credentials: true   // è¡¨ç¤ºæ˜¯å¦å…è®¸å‘é€Cookie
Access-Control-Expose-Headers: FooBar   // æŒ‡å®šè¿”å›å…¶ä»–å­—æ®µçš„å€¼
Content-Type: text/html; charset=utf-8   // è¡¨ç¤ºæ–‡æ¡£ç±»å‹
```

å¦‚æœæŒ‡å®šçš„åŸŸåä¸åœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„`HTTP`å›åº”ï¼Œæµè§ˆå™¨å‘ç°æ²¡æœ‰ä¸Šé¢çš„`Access-Control-Allow-Origin`ï¼Œè¡¨ç¤ºå°±å‡ºé”™äº†ï¼Œè¿™ä¸ªæ˜¯æ— æ³•é€šè¿‡çŠ¶æ€ç è¿›è¡Œåˆ¤æ–­çš„

## ç®€è¿°ä¸€ä¸‹éç®€å•è¯·æ±‚çš„è¿‡ç¨‹

éç®€å•è¯·æ±‚æ¯”å¦‚`DELETE` `PUT`ä¼šåœ¨æ­£å¼é€šä¿¡ä¹‹å‰ä¼šè¿›è¡Œä¸€æ¬¡é¢„æ£€è¯·æ±‚ï¼Œå°±æ˜¯å½“å‰æ‰€åœ¨çš„ç½‘é¡µæ˜¯å¦åœ¨æœåŠ¡å™¨å…è®¸è®¿é—®çš„èŒƒå›´å†…ï¼Œä»¥åŠå¯ä»¥ä½¿ç”¨çš„è¯·æ±‚æ–¹æ³•ï¼Œåªæœ‰å¾—åˆ°æœåŠ¡ç«¯è‚¯å®šçš„å›å¤æ‰èƒ½è¿›è¡Œæ­£å¼çš„`HTTP`è¯·æ±‚ï¼Œå¦åˆ™å°±ä¼šæŠ¥é”™

é¢„æ£€çš„è¯·æ±‚æ–¹æ³•æ˜¯`option`ï¼Œä»–çš„å¤´ä¿¡æ¯å…³é”®å°±æ˜¯`origin`ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰

- **`Access-Control-Request-Method`**ï¼šè¯¥å­—æ®µæ˜¯å¿…é¡»çš„ï¼Œç”¨æ¥åˆ—å‡ºæµè§ˆå™¨çš„CORSè¯·æ±‚ä¼šç”¨åˆ°å“ªäº›HTTPæ–¹æ³•ã€‚
- **`Access-Control-Request-Headers`**ï¼š è¯¥å­—æ®µæ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šæµè§ˆå™¨`CORS`è¯·æ±‚ä¼šé¢å¤–å‘é€çš„å¤´ä¿¡æ¯å­—æ®µ

å¦‚æœæœåŠ¡å™¨æ ¹æ®å¤´ä¿¡æ¯çš„ä¸‰ä¸ªå­—æ®µè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿”å›çš„å¤´ä¿¡æ¯æœ‰`Access-Control-Allow-Origin`å°±æ˜¯å…è®¸è·¨åŸŸè¯·æ±‚

æœåŠ¡å™¨è¿”å›çš„corså­—æ®µæœ‰

```http
Access-Control-Allow-Origin: http://api.bob.com  // å…è®¸è·¨åŸŸçš„æºåœ°å€
Access-Control-Allow-Methods: GET, POST, PUT // æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰è·¨åŸŸè¯·æ±‚çš„æ–¹æ³•
Access-Control-Allow-Headers: X-Custom-Header  // æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µ
Access-Control-Allow-Credentials: true   // è¡¨ç¤ºæ˜¯å¦å…è®¸å‘é€Cookie
Access-Control-Max-Age: 1728000  // ç”¨æ¥æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’
```

å‰ä¸‰ä¸ªæ˜¯æœåŠ¡ç«¯æ˜¯å¿…é¡»è¿”å›çš„å­—æ®µ



::: warning å€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­è¦å‡å°‘`options`è¯·æ±‚æ¬¡æ•°ï¼Œå› ä¸º

- è¯·æ±‚æ¬¡æ•°è¿‡å¤šä¼šæŸè€—é¡µé¢çš„åŠ è½½æ€§èƒ½ï¼Œé™ä½ç”¨æˆ·ä½“éªŒåº¦
- å¯ä»¥åœ¨åç«¯è¿”å›å¤´éƒ¨æ·»åŠ `Access-Control-Max-Age`è¡¨ç¤ºå¯ä»¥è¢«ç¼“å­˜å¤šä¹…ï¼Œå•ä½æ˜¯ç§’ï¼Œå¯¹å®Œå…¨ä¸€æ ·çš„URLç¼“å­˜è®¾ç½®ç”Ÿæ•ˆï¼Œåœ¨è¿™ä¸ªæ—¶é—´æ®µå†…å°±ä¸éœ€è¦é¢„æ£€äº†

:::

è¿˜æœ‰ä¸€ä¸ªæ˜¯`CORS`ä¸­çš„`cookies`é—®é¢˜

åœ¨`CORS`è¯·æ±‚ä¸­å¦‚æœæƒ³ä¼ é€’`cookies`ï¼Œè¦æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼š

- åœ¨è¯·æ±‚ä¸­åŠ ä¸Š`withCredentials`

```javascript
// åŸç”Ÿ xml çš„è®¾ç½®æ–¹å¼
var xhr = new XMLHttpRequest();
xhr.withCredentials = true;
// axios è®¾ç½®æ–¹å¼
axios.defaults.withCredentials = true;
```

- `Access-Control-Allow-Credentials` è®¾ç½®ä¸º `true`
- `Access-Control-Allow-Origin` è®¾ç½®ä¸ºé  `*`

## å…¶ä»–è·¨åŸŸæ–¹å¼

### JSONP

::: tip åŸç†

åˆ©ç”¨`<script>`æ ‡ç­¾æ²¡æœ‰è·¨åŸŸé™åˆ¶ï¼Œé€šè¿‡`<script>`æ ‡ç­¾`src`å±æ€§ï¼Œå‘é€å¸¦æœ‰`callback`å‚æ•°çš„`GET`è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å°†æ¥å£è¿”å›æ•°æ®æ‹¼å‡‘åˆ°`callback`å‡½æ•°ä¸­ï¼Œè¿”å›ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨è§£ææ‰§è¡Œï¼Œä»è€Œå‰ç«¯æ‹¿åˆ°`callback`å‡½æ•°è¿”å›çš„æ•°æ®ã€‚

::: 

```javascript
<script>
    var script = document.createElement('script');
    script.type = 'text/javascript';
    // ä¼ å‚ä¸€ä¸ªå›è°ƒå‡½æ•°åç»™åç«¯ï¼Œæ–¹ä¾¿åç«¯è¿”å›æ—¶æ‰§è¡Œè¿™ä¸ªåœ¨å‰ç«¯å®šä¹‰çš„å›è°ƒå‡½æ•°
    script.src = 'http://www.crucials:80/login?user=admin&callback=handleCallback';
    document.head.appendChild(script);
    // å›è°ƒæ‰§è¡Œå‡½æ•°
    function handleCallback(res) {
        alert(JSON.stringify(res));
    }
 </script>
```

æœåŠ¡ç«¯è¿”å›å¦‚ä¸‹ï¼ˆè¿”å›æ—¶å³æ‰§è¡Œå…¨å±€å‡½æ•°ï¼‰

```javascript
handleCallback({"success": true, "user": "admin"})
```

`Vue axios`å®ç°

```javascript
this.$http = axios;
this.$http.jsonp('http://www.crucials:80/login', {
    params: {},
    jsonp: 'handleCallback'
}).then((res) => {
    console.log(res); 
})
```

`nodejs`ä»£ç 

```javascript
var querystring = require('querystring');
var http = require('http');
var server = http.createServer();
server.on('request', function(req, res) {
    var params = querystring.parse(req.url.split('?')[1]);
    var fn = params.callback;
    // jsonpè¿”å›è®¾ç½®
    res.writeHead(200, { 'Content-Type': 'text/javascript' });
    res.write(fn + '(' + JSON.stringify(params) + ')');
    res.end();
});
server.listen('80');
console.log('Server is running at port 80...');
```

å½“ç„¶ç¼ºç‚¹å°±æ˜¯ä»…æ”¯æŒ`get`æ–¹æ³•å’Œä¸å®‰å…¨ï¼Œå¯èƒ½é­åˆ°`xss`æ”»å‡»

### `postMessage`è·¨åŸŸ

ä¸»è¦è§£å†³äº†

- é¡µé¢å’Œå…¶æ‰“å¼€çš„æ–°çª—å£çš„æ•°æ®ä¼ é€’
- å¤šçª—å£ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’

- é¡µé¢ä¸åµŒå¥—çš„`iframe`æ¶ˆæ¯ä¼ é€’

ç”¨æ³•ï¼š`postMessage(data,origin)`æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š

- **`data`**ï¼š `html5`è§„èŒƒæ”¯æŒä»»æ„åŸºæœ¬ç±»å‹æˆ–å¯å¤åˆ¶çš„å¯¹è±¡ï¼Œä½†éƒ¨åˆ†æµè§ˆå™¨åªæ”¯æŒå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¼ å‚æ—¶æœ€å¥½ç”¨`JSON.stringify()`åºåˆ—åŒ–ã€‚
- **`origin`**ï¼š åè®®+ä¸»æœº+ç«¯å£å·ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸º"*"ï¼Œè¡¨ç¤ºå¯ä»¥ä¼ é€’ç»™ä»»æ„çª—å£ï¼Œå¦‚æœè¦æŒ‡å®šå’Œå½“å‰çª—å£åŒæºçš„è¯è®¾ç½®ä¸º"/"ã€‚

1ï¼‰`a.htmlï¼š(a.com/a.html)`

```javascript
<iframe id="iframe" src="http://www.b.com/b.html" style="display:none;"></iframe>
<script>       
    var iframe = document.getElementById('iframe');
    iframe.onload = function() {
        var data = {
            name: 'aym'
        };
        // å‘bä¼ é€è·¨åŸŸæ•°æ®
        iframe.contentWindow.postMessage(JSON.stringify(data), 'http://www.b.com');
    };
    // æ¥å—bè¿”å›æ•°æ®
    window.addEventListener('message', function(e) {
        alert('data from b ---> ' + e.data);
    }, false);
</script>
```

2ï¼‰`b.htmlï¼š(b.com/b.html)`

```javascript
<script>
    // æ¥æ”¶açš„æ•°æ®
    window.addEventListener('message', function(e) {
        alert('data from a ---> ' + e.data);
        var data = JSON.parse(e.data);
        if (data) {
            data.number = 16;
            // å¤„ç†åå†å‘å›a
            window.parent.postMessage(JSON.stringify(data), 'http://www.a.com');
        }
    }, false);
</script>
```

### `nginx`ä»£ç†è·¨åŸŸ

å®é™…ä¸Šä¸`CORS`è·¨åŸŸåŸç†ä¸€æ ·ï¼Œéƒ½æ˜¯é…ç½®`Access-Control-Allow-Origin`â€¦ç­‰å­—æ®µã€‚

`nginx`é…ç½®è§£å†³`iconfont`è·¨åŸŸ æµè§ˆå™¨è·¨åŸŸè®¿é—®`js`ã€`css`ã€`img`ç­‰å¸¸è§„é™æ€èµ„æºè¢«åŒæºç­–ç•¥è®¸å¯ï¼Œä½†`iconfont`å­—ä½“æ–‡ä»¶(`eot|otf|ttf|woff|svg`)ä¾‹å¤–ï¼Œæ­¤æ—¶å¯åœ¨`nginx`çš„é™æ€èµ„æºæœåŠ¡å™¨ä¸­åŠ å…¥ä»¥ä¸‹é…ç½®

```javascript
location / {
  add_header Access-Control-Allow-Origin *;
}
```

::: note nginxåå‘ä»£ç†æ¥å£è·¨åŸŸ è·¨åŸŸé—®é¢˜

åŒæºç­–ç•¥ä»…æ˜¯é’ˆå¯¹æµè§ˆå™¨çš„å®‰å…¨ç­–ç•¥ã€‚æœåŠ¡å™¨ç«¯è°ƒç”¨`HTTP`æ¥å£åªæ˜¯ä½¿ç”¨`HTTP`åè®®ï¼Œä¸éœ€è¦åŒæºç­–ç•¥ï¼Œä¹Ÿå°±ä¸å­˜åœ¨è·¨åŸŸé—®é¢˜ã€‚ 

å®ç°æ€è·¯ï¼šé€šè¿‡`Nginx`é…ç½®ä¸€ä¸ªä»£ç†æœåŠ¡å™¨åŸŸåä¸`a`ç›¸åŒï¼Œç«¯å£ä¸åŒï¼‰åšè·³æ¿æœºï¼Œåå‘ä»£ç†è®¿é—®`b`æ¥å£ï¼Œå¹¶ä¸”å¯ä»¥é¡ºä¾¿ä¿®æ”¹`cookie`ä¸­`domain`ä¿¡æ¯ï¼Œæ–¹ä¾¿å½“å‰åŸŸ`cookie`å†™å…¥ï¼Œå®ç°è·¨åŸŸè®¿é—®

:::

```nginx
#proxyæœåŠ¡å™¨
server {
    listen       81;
    server_name  www.a.com;
    location / {
        proxy_pass   http://www.b.com:8080;  #åå‘ä»£ç†
        proxy_cookie_domain www.b.com www.a.com; #ä¿®æ”¹cookieé‡ŒåŸŸå
        index  index.html index.htm;
        # å½“ç”¨webpack-dev-serverç­‰ä¸­é—´ä»¶ä»£ç†æ¥å£è®¿é—®nignxæ—¶ï¼Œæ­¤æ—¶æ— æµè§ˆå™¨å‚ä¸ï¼Œæ•…æ²¡æœ‰åŒæºé™åˆ¶ï¼Œä¸‹é¢çš„è·¨åŸŸé…ç½®å¯ä¸å¯ç”¨
        add_header Access-Control-Allow-Origin http://www.a.com;  #å½“å‰ç«¯åªè·¨åŸŸä¸å¸¦cookieæ—¶ï¼Œå¯ä¸º*
        add_header Access-Control-Allow-Credentials true;
    }
}
```

### `nodejs`ä¸­é—´ä»¶ä»£ç†è·¨åŸŸ

åŸç†ä¹Ÿä¸`nginx`å¤§è‡´ç›¸åŒï¼Œéƒ½æ˜¯é€šè¿‡ä»£ç†ç„¶åè¿›è¡Œè½¬å‘ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®`cookiesDomainRewrite`å‚æ•°ä¿®æ”¹å“åº”å¤´ä¸­`cookies`ä¸­åŸŸåï¼Œå®ç°å½“å‰åŸŸçš„`cookies`å†™å…¥ï¼Œæ–¹ä¾¿æ¥å£ç™»é™†è®¤è¯

**é`vue`æ¡†æ¶çš„è·¨åŸŸ** ä½¿ç”¨`node + express + http-proxy-middleware`æ­å»ºä¸€ä¸ª`proxy`æœåŠ¡å™¨

å‰ç«¯ï¼š

```javascript
var xhr = new XMLHttpRequest();
// å‰ç«¯å¼€å…³ï¼šæµè§ˆå™¨æ˜¯å¦è¯»å†™cookie
xhr.withCredentials = true;
// è®¿é—®http-proxy-middlewareä»£ç†æœåŠ¡å™¨
xhr.open('get', 'http://www.a.com:3000/login?user=admin', true);
xhr.send();
```

ä¸­é—´ä»¶æœåŠ¡å™¨ä»£ç 

```javascript
var express = require('express');
var proxy = require('http-proxy-middleware');
var app = express();
app.use('/', proxy({
    // ä»£ç†è·¨åŸŸç›®æ ‡æ¥å£
    target: 'http://www.b.com:8080',
    changeOrigin: true,
    // ä¿®æ”¹å“åº”å¤´ä¿¡æ¯ï¼Œå®ç°è·¨åŸŸå¹¶å…è®¸å¸¦cookie
    onProxyRes: function(proxyRes, req, res) {
        res.header('Access-Control-Allow-Origin', 'http://www.a.com');
        res.header('Access-Control-Allow-Credentials', 'true');
    },
    // ä¿®æ”¹å“åº”ä¿¡æ¯ä¸­çš„cookieåŸŸå
    cookieDomainRewrite: 'www.a.com'  // å¯ä»¥ä¸ºfalseï¼Œè¡¨ç¤ºä¸ä¿®æ”¹
}));
app.listen(3000);
console.log('Proxy server is listen at port 3000...');
```

### `iframe`è·¨åŸŸ

:::note ä¸ªæ„Ÿè§‰æ²¡é‚£ä¹ˆé‡è¦

:::

::: details

#### `document.domain` + `iframe`è·¨åŸŸ

ä»…é™ä¸»åŸŸç›¸åŒï¼Œå­åŸŸä¸åŒçš„è·¨åŸŸåº”ç”¨åœºæ™¯ï¼Œå®ç°åŸç†ï¼šä¸¤ä¸ªé¡µé¢éƒ½é€šè¿‡jså¼ºåˆ¶è®¾ç½®`document.domain`ä¸ºåŸºç¡€ä¸»åŸŸï¼Œå°±å®ç°äº†åŒåŸŸ

1ï¼‰çˆ¶çª—å£ï¼š(`domain.com/a.html`)

```javascript
<iframe id="iframe" src="http://child.domain.com/b.html"></iframe>
<script>
    document.domain = 'domain.com';
    var user = 'admin';
</script>
```

å­çª—å£ï¼š(`child.domain.com/a.html`)

```javascript
<script>
    document.domain = 'domain.com';
    // è·å–çˆ¶çª—å£ä¸­å˜é‡
    console.log('get js data from parent ---> ' + window.parent.user);
</script>
```

#### `location.hash + iframe`è·¨åŸŸ

å®ç°åŸç†ï¼š`a`æ¬²ä¸`b`è·¨åŸŸç›¸äº’é€šä¿¡ï¼Œé€šè¿‡ä¸­é—´é¡µ`c`æ¥å®ç°ã€‚ ä¸‰ä¸ªé¡µé¢ï¼Œä¸åŒåŸŸä¹‹é—´åˆ©ç”¨`iframeçš„location.hash`ä¼ å€¼ï¼Œç›¸åŒåŸŸä¹‹é—´ç›´æ¥jsè®¿é—®æ¥é€šä¿¡ã€‚

å…·ä½“å®ç°ï¼šAåŸŸï¼ša.html -> BåŸŸï¼šb.html -> AåŸŸï¼šc.htmlï¼Œaä¸bä¸åŒåŸŸåªèƒ½é€šè¿‡hashå€¼å•å‘é€šä¿¡ï¼Œbä¸cä¹Ÿä¸åŒåŸŸä¹Ÿåªèƒ½å•å‘é€šä¿¡ï¼Œä½†cä¸aåŒåŸŸï¼Œæ‰€ä»¥cå¯é€šè¿‡`parent.parent`è®¿é—®aé¡µé¢æ‰€æœ‰å¯¹è±¡

`a.htmlï¼š(www.a.com/a.html)`

```javascript
<iframe id="iframe" src="http://www.b.com/b.html" style="display:none;"></iframe>
<script>
    var iframe = document.getElementById('iframe');
    // å‘b.htmlä¼ hashå€¼
    setTimeout(function() {
        iframe.src = iframe.src + '#user=admin';
    }, 1000);
    
    // å¼€æ”¾ç»™åŒåŸŸc.htmlçš„å›è°ƒæ–¹æ³•
    function onCallback(res) {
        alert('data from c.html ---> ' + res);
    }
</script>
```

2ï¼‰`b.htmlï¼š(www.b.com/b.html)`

```javascript
<iframe id="iframe" src="http://www.a.com/c.html" style="display:none;"></iframe>
<script>
    var iframe = document.getElementById('iframe');
    // ç›‘å¬a.htmlä¼ æ¥çš„hashå€¼ï¼Œå†ä¼ ç»™c.html
    window.onhashchange = function () {
        iframe.src = iframe.src + location.hash;
    };
</script>
```

3ï¼‰`c.htmlï¼š(www.a.com/c.html)`

```javascript
<script>
    // ç›‘å¬b.htmlä¼ æ¥çš„hashå€¼
    window.onhashchange = function () {
        // å†é€šè¿‡æ“ä½œåŒåŸŸa.htmlçš„jså›è°ƒï¼Œå°†ç»“æœä¼ å›
        window.parent.parent.onCallback('hello: ' + location.hash.replace('#user=', ''));
    };
</script>
```

#### `window.name + iframe`è·¨åŸŸ

`window.name`å±æ€§çš„ç‹¬ç‰¹ä¹‹å¤„ï¼š`name`å€¼åœ¨ä¸åŒçš„é¡µé¢ï¼ˆç”šè‡³ä¸åŒåŸŸåï¼‰åŠ è½½åä¾æ—§å­˜åœ¨ï¼Œå¹¶ä¸”å¯ä»¥æ”¯æŒéå¸¸é•¿çš„ `name` å€¼ï¼ˆ`2MB`ï¼‰

1ï¼‰`a.htmlï¼š(a.com/a.html)`

```javascript
var proxy = function(url, callback) {
    var state = 0;
    var iframe = document.createElement('iframe');
    // åŠ è½½è·¨åŸŸé¡µé¢
    iframe.src = url;
    // onloadäº‹ä»¶ä¼šè§¦å‘2æ¬¡ï¼Œç¬¬1æ¬¡åŠ è½½è·¨åŸŸé¡µï¼Œå¹¶ç•™å­˜æ•°æ®äºwindow.name
    iframe.onload = function() {
        if (state === 1) {
            // ç¬¬2æ¬¡onload(åŒåŸŸproxyé¡µ)æˆåŠŸåï¼Œè¯»å–åŒåŸŸwindow.nameä¸­æ•°æ®
            callback(iframe.contentWindow.name);
            destoryFrame();
        } else if (state === 0) {
            // ç¬¬1æ¬¡onload(è·¨åŸŸé¡µ)æˆåŠŸåï¼Œåˆ‡æ¢åˆ°åŒåŸŸä»£ç†é¡µé¢
            iframe.contentWindow.location = 'http://www.a.com/proxy.html';
            state = 1;
        }
    };
    document.body.appendChild(iframe);
    // è·å–æ•°æ®ä»¥åé”€æ¯è¿™ä¸ªiframeï¼Œé‡Šæ”¾å†…å­˜ï¼›è¿™ä¹Ÿä¿è¯äº†å®‰å…¨ï¼ˆä¸è¢«å…¶ä»–åŸŸframe jsè®¿é—®ï¼‰
    function destoryFrame() {
        iframe.contentWindow.document.write('');
        iframe.contentWindow.close();
        document.body.removeChild(iframe);
    }
};
// è¯·æ±‚è·¨åŸŸbé¡µé¢æ•°æ®
proxy('http://www.b.com/b.html', function(data){
    alert(data);
});
```

2ï¼‰`proxy.htmlï¼š(a.com/proxy.html)`

ä¸­é—´ä»£ç†é¡µï¼Œä¸`a.html`åŒåŸŸï¼Œå†…å®¹ä¸ºç©ºå³å¯ã€‚ 

3ï¼‰`b.htmlï¼š(b.com/b.html)`

```javascript
<script>    
    window.name = 'This is b data!';
</script>
```

é€šè¿‡`iframe`çš„`src`å±æ€§ç”±å¤–åŸŸè½¬å‘æœ¬åœ°åŸŸï¼Œè·¨åŸŸæ•°æ®å³ç”±`iframe`çš„`window.name`ä»å¤–åŸŸä¼ é€’åˆ°æœ¬åœ°åŸŸã€‚è¿™ä¸ªå°±å·§å¦™åœ°ç»•è¿‡äº†æµè§ˆå™¨çš„è·¨åŸŸè®¿é—®é™åˆ¶ï¼Œä½†åŒæ—¶å®ƒåˆæ˜¯å®‰å…¨æ“ä½œ

:::

### `WebSocket`åè®®è·¨åŸŸ

::: note è¿™ä¸ªæ„Ÿè§‰ä¹Ÿä¸å¤ªé‡è¦çš„ğŸ¦†

:::

åŸç”Ÿ`WebSocket API`ä½¿ç”¨èµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬ä½¿ç”¨`Socket.io`ï¼Œå®ƒå¾ˆå¥½åœ°å°è£…äº†`webSocket`æ¥å£ï¼Œæä¾›äº†æ›´ç®€å•ã€çµæ´»çš„æ¥å£ï¼Œä¹Ÿå¯¹ä¸æ”¯æŒ`webSocket`çš„æµè§ˆå™¨æä¾›äº†å‘ä¸‹å…¼å®¹

å‰ç«¯ï¼š

```javascript
<div>user inputï¼š<input type="text"></div>
<script src="https://cdn.bootcss.com/socket.io/2.2.0/socket.io.js"></script>
<script>
var socket = io('http://www.b.com:8080');
// è¿æ¥æˆåŠŸå¤„ç†
socket.on('connect', function() {
    // ç›‘å¬æœåŠ¡ç«¯æ¶ˆæ¯
    socket.on('message', function(msg) {
        console.log('data from server: ---> ' + msg); 
    });
    // ç›‘å¬æœåŠ¡ç«¯å…³é—­
    socket.on('disconnect', function() { 
        console.log('Server socket has closed.'); 
    });
});
document.getElementsByTagName('input')[0].onblur = function() {
    socket.send(this.value);
};
</script>
```

`node:`

```javascript
var http = require('http');
var socket = require('socket.io');
// å¯httpæœåŠ¡
var server = http.createServer(function(req, res) {
    res.writeHead(200, {
        'Content-type': 'text/html'
    });
    res.end();
});
server.listen('8080');
console.log('Server is running at port 8080...');
// ç›‘å¬socketè¿æ¥
socket.listen(server).on('connection', function(client) {
    // æ¥æ”¶ä¿¡æ¯
    client.on('message', function(msg) {
        client.send('helloï¼š' + msg);
        console.log('data from client: ---> ' + msg);
    });
    // æ–­å¼€å¤„ç†
    client.on('disconnect', function() {
        console.log('Client socket has closed.'); 
    });
});
```

## ä»‹ç»ä¸€ä¸‹æ­£å‘ä»£ç†å’Œåå‘ä»£ç†

- <mark>æ­£å‘ä»£ç†</mark>
  - å®¢æˆ·ç«¯æƒ³è·å¾—ä¸€ä¸ªæœåŠ¡å™¨çš„æ•°æ®ï¼Œä½†æ˜¯å› ä¸ºç§ç§åŸå› æ— æ³•ç›´æ¥è·å–ã€‚äºæ˜¯å®¢æˆ·ç«¯è®¾ç½®äº†ä¸€ä¸ªä»£ç†æœåŠ¡å™¨ï¼Œå¹¶ä¸”æŒ‡å®šç›®æ ‡æœåŠ¡å™¨ï¼Œä¹‹åä»£ç†æœåŠ¡å™¨å‘ç›®æ ‡æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹å‘é€ç»™å®¢æˆ·ç«¯ã€‚è¿™æ ·æœ¬è´¨ä¸Šèµ·åˆ°äº†å¯¹çœŸå®æœåŠ¡å™¨**éšè—çœŸå®å®¢æˆ·ç«¯**çš„ç›®çš„ã€‚å®ç°æ­£å‘ä»£ç†éœ€è¦ä¿®æ”¹å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚ä¿®æ”¹æµè§ˆå™¨é…ç½®

- <mark>åå‘ä»£ç†</mark>
  - æœåŠ¡å™¨ä¸ºäº†èƒ½å¤Ÿ**å°†å·¥ä½œè´Ÿè½½åˆ†é…åˆ°å¤šä¸ªæœåŠ¡å™¨æ¥æé«˜ç½‘ç«™æ€§èƒ½ (è´Ÿè½½å‡è¡¡)ç­‰ç›®çš„**ï¼Œå½“å…¶å—åˆ°è¯·æ±‚åï¼Œä¼šé¦–å…ˆæ ¹æ®è½¬å‘è§„åˆ™æ¥ç¡®å®šè¯·æ±‚åº”è¯¥è¢«è½¬å‘åˆ°å“ªä¸ªæœåŠ¡å™¨ä¸Šï¼Œç„¶åå°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„çœŸå®æœåŠ¡å™¨ä¸Šã€‚è¿™æ ·æœ¬è´¨ä¸Šèµ·åˆ°äº†**å¯¹å®¢æˆ·ç«¯éšè—çœŸå®æœåŠ¡å™¨**çš„ä½œç”¨ã€‚ ä¸€èˆ¬ä½¿ç”¨åå‘ä»£ç†åï¼Œéœ€è¦é€šè¿‡ä¿®æ”¹ `DNS` è®©åŸŸåè§£æåˆ°ä»£ç†æœåŠ¡å™¨ `IP`ï¼Œè¿™æ—¶æµè§ˆå™¨æ— æ³•å¯Ÿè§‰åˆ°çœŸæ­£æœåŠ¡å™¨çš„å­˜åœ¨ï¼Œå½“ç„¶ä¹Ÿå°±ä¸éœ€è¦ä¿®æ”¹é…ç½®äº†


![img](https://cdn.jsdelivr.net/gh/duochizhacai/generatePic/img/202112161753999.png)

**åŒºåˆ«ï¼š**

æ­£å‘ä»£ç†å’Œåå‘ä»£ç†ç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯`client-proxy-server`çš„ç»“æ„ï¼Œä»–ä»¬ä¸»è¦çš„åŒºåˆ«æ˜¯åœ¨äºä¸­é—´çš„`proxy`æ˜¯å“ªä¸€æ–¹è®¾ç½®çš„ï¼Œåœ¨æ­£å‘ä»£ç†ä¸­ï¼Œ`proxy`æ˜¯`client`è®¾ç½®çš„ï¼Œç”¨æ¥éšè—`client`ï¼Œè€Œåœ¨åå‘ä»£ç†ä¸­ï¼Œ`proxy`æ˜¯`server`è®¾ç½®çš„ï¼Œç”¨äºéšè—`server`



## `nginx`æ¦‚å¿µåŠå…¶å·¥ä½œåŸç†

`Nginx` æ˜¯ä¸€æ¬¾è½»é‡çº§çš„ `Web` æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ç”¨äºåå‘ä»£ç†ã€è´Ÿè½½å¹³è¡¡å’Œ `HTTP` ç¼“å­˜ç­‰ã€‚`Nginx` ä½¿ç”¨å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„æ–¹æ³•æ¥å¤„ç†è¯·æ±‚ï¼Œæ˜¯ä¸€æ¬¾é¢å‘æ€§èƒ½è®¾è®¡çš„ `HTTP` æœåŠ¡å™¨ã€‚

ä¼ ç»Ÿçš„ `Web` æœåŠ¡å™¨å¦‚ `Apache` æ˜¯ `process-based` æ¨¡å‹çš„ï¼Œè€Œ `Nginx` æ˜¯åŸºäº`event-driven`æ¨¡å‹çš„ã€‚æ­£æ˜¯è¿™ä¸ªä¸»è¦çš„åŒºåˆ«å¸¦ç»™äº† `Nginx` åœ¨æ€§èƒ½ä¸Šçš„ä¼˜åŠ¿ã€‚

`Nginx` æ¶æ„çš„æœ€é¡¶å±‚æ˜¯ä¸€ä¸ª `master process`ï¼Œè¿™ä¸ª `master process` ç”¨äºäº§ç”Ÿå…¶ä»–çš„ `worker process`ï¼Œè¿™ä¸€ç‚¹å’Œ`Apache` éå¸¸åƒï¼Œä½†æ˜¯ `Nginx` çš„ `worker process` å¯ä»¥åŒæ—¶å¤„ç†å¤§é‡çš„`HTTP`è¯·æ±‚ï¼Œè€Œæ¯ä¸ª `Apache process` åªèƒ½å¤„ç†ä¸€ä¸ª
