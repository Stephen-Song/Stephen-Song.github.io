<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NodeJS | 小宋爱睡觉</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="🚀一个前端程序员小白的博客🌹">
    <meta name="keywords" content="blog,crucials,frontend,前端,小宋爱睡觉,博客,duochizhacai">
    <meta name="theme-color" content="#60ad81">
    
    <link rel="preload" href="/assets/css/0.styles.65787d8c.css" as="style"><link rel="preload" href="/assets/js/app.95fc12d6.js" as="script"><link rel="preload" href="/assets/js/2.abf57e2f.js" as="script"><link rel="preload" href="/assets/js/80.6c258060.js" as="script"><link rel="preload" href="/assets/js/3.e687237e.js" as="script"><link rel="prefetch" href="/assets/js/10.9d6bb65c.js"><link rel="prefetch" href="/assets/js/11.bea1ca2d.js"><link rel="prefetch" href="/assets/js/12.a5ced6a2.js"><link rel="prefetch" href="/assets/js/13.ec1bcac6.js"><link rel="prefetch" href="/assets/js/14.4e5bcc62.js"><link rel="prefetch" href="/assets/js/15.753bb2dc.js"><link rel="prefetch" href="/assets/js/16.a6e51bcc.js"><link rel="prefetch" href="/assets/js/17.25227dca.js"><link rel="prefetch" href="/assets/js/18.19267273.js"><link rel="prefetch" href="/assets/js/19.a9403a12.js"><link rel="prefetch" href="/assets/js/20.c007e659.js"><link rel="prefetch" href="/assets/js/21.dca7af69.js"><link rel="prefetch" href="/assets/js/22.d9f25771.js"><link rel="prefetch" href="/assets/js/23.2668c7ed.js"><link rel="prefetch" href="/assets/js/24.30c858a4.js"><link rel="prefetch" href="/assets/js/25.bd21abb1.js"><link rel="prefetch" href="/assets/js/26.28d250cb.js"><link rel="prefetch" href="/assets/js/27.a60d212f.js"><link rel="prefetch" href="/assets/js/28.8a5c2c34.js"><link rel="prefetch" href="/assets/js/29.4688a5d6.js"><link rel="prefetch" href="/assets/js/30.5985f3b4.js"><link rel="prefetch" href="/assets/js/31.7ee5d916.js"><link rel="prefetch" href="/assets/js/32.2f711dea.js"><link rel="prefetch" href="/assets/js/33.45a4e58a.js"><link rel="prefetch" href="/assets/js/34.6a46cad8.js"><link rel="prefetch" href="/assets/js/35.79084a19.js"><link rel="prefetch" href="/assets/js/36.9a5cf509.js"><link rel="prefetch" href="/assets/js/37.ea6b36a3.js"><link rel="prefetch" href="/assets/js/38.1ebed809.js"><link rel="prefetch" href="/assets/js/39.16200e67.js"><link rel="prefetch" href="/assets/js/4.4a0efd85.js"><link rel="prefetch" href="/assets/js/40.db1f5064.js"><link rel="prefetch" href="/assets/js/41.5c8205b4.js"><link rel="prefetch" href="/assets/js/42.d8e671a9.js"><link rel="prefetch" href="/assets/js/43.80c6d459.js"><link rel="prefetch" href="/assets/js/44.0dc33dbe.js"><link rel="prefetch" href="/assets/js/45.e623e04e.js"><link rel="prefetch" href="/assets/js/46.b9a46fc2.js"><link rel="prefetch" href="/assets/js/47.2d5eb349.js"><link rel="prefetch" href="/assets/js/48.8d4e8a09.js"><link rel="prefetch" href="/assets/js/49.f7f58461.js"><link rel="prefetch" href="/assets/js/5.84799806.js"><link rel="prefetch" href="/assets/js/50.b482896d.js"><link rel="prefetch" href="/assets/js/51.9ad2b264.js"><link rel="prefetch" href="/assets/js/52.7862671c.js"><link rel="prefetch" href="/assets/js/53.d8153804.js"><link rel="prefetch" href="/assets/js/54.0af2674d.js"><link rel="prefetch" href="/assets/js/55.597b91b8.js"><link rel="prefetch" href="/assets/js/56.46804158.js"><link rel="prefetch" href="/assets/js/57.006f6db0.js"><link rel="prefetch" href="/assets/js/58.751e40d0.js"><link rel="prefetch" href="/assets/js/59.b0ebe0e6.js"><link rel="prefetch" href="/assets/js/6.f7ec0152.js"><link rel="prefetch" href="/assets/js/60.8d675b12.js"><link rel="prefetch" href="/assets/js/61.55190a7f.js"><link rel="prefetch" href="/assets/js/62.117f5f66.js"><link rel="prefetch" href="/assets/js/63.b848bfe2.js"><link rel="prefetch" href="/assets/js/64.000227a3.js"><link rel="prefetch" href="/assets/js/65.9ec404e1.js"><link rel="prefetch" href="/assets/js/66.1834b2b1.js"><link rel="prefetch" href="/assets/js/67.bf716de8.js"><link rel="prefetch" href="/assets/js/68.6e03054c.js"><link rel="prefetch" href="/assets/js/69.c6605c56.js"><link rel="prefetch" href="/assets/js/7.40c08f02.js"><link rel="prefetch" href="/assets/js/70.30051d78.js"><link rel="prefetch" href="/assets/js/71.1fdc7d36.js"><link rel="prefetch" href="/assets/js/72.4b0ad4ad.js"><link rel="prefetch" href="/assets/js/73.e989ab6d.js"><link rel="prefetch" href="/assets/js/74.02429c23.js"><link rel="prefetch" href="/assets/js/75.8f044cef.js"><link rel="prefetch" href="/assets/js/76.7acc2de5.js"><link rel="prefetch" href="/assets/js/77.ce127400.js"><link rel="prefetch" href="/assets/js/78.deb1ae24.js"><link rel="prefetch" href="/assets/js/79.75a4c78b.js"><link rel="prefetch" href="/assets/js/8.303c64d8.js"><link rel="prefetch" href="/assets/js/81.563a0c28.js"><link rel="prefetch" href="/assets/js/82.143b4caf.js"><link rel="prefetch" href="/assets/js/83.32431b7f.js"><link rel="prefetch" href="/assets/js/84.2320a5a5.js"><link rel="prefetch" href="/assets/js/85.d9a1625a.js"><link rel="prefetch" href="/assets/js/86.dc0f47f2.js"><link rel="prefetch" href="/assets/js/87.8335157f.js"><link rel="prefetch" href="/assets/js/88.2cfc7001.js"><link rel="prefetch" href="/assets/js/89.6bc590c2.js"><link rel="prefetch" href="/assets/js/9.7ba1b2de.js"><link rel="prefetch" href="/assets/js/90.c20801a7.js"><link rel="prefetch" href="/assets/js/91.1a32fafc.js"><link rel="prefetch" href="/assets/js/92.4a802465.js">
    <link rel="stylesheet" href="/assets/css/0.styles.65787d8c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.jsdelivr.net/gh/duochizhacai/generatePic/img/logo.png" alt="小宋爱睡觉" class="logo"> <span class="site-name can-hide">小宋爱睡觉</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识库" class="dropdown-title"><a href="/pages/56881f/" class="link-title">知识库</a> <span class="title" style="display:none;">知识库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/56881f/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/c0e7f0/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/787250/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/pages/f0a671/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/pages/b7238f/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/pages/2448f7/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/pages/b8bd46/" class="nav-link">浏览器原理</a></li><li class="dropdown-item"><!----> <a href="/pages/f15087/" class="nav-link">性能优化</a></li><li class="dropdown-item"><!----> <a href="/pages/e3cba5/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><a href="/pages/ba01c4/" class="nav-link">手写系列</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><a href="/pages/ad5191/" class="link-title">算法</a> <span class="title" style="display:none;">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8ac126/" class="nav-link">字符串</a></li><li class="dropdown-item"><!----> <a href="/pages/251490/" class="nav-link">数组</a></li><li class="dropdown-item"><!----> <a href="/pages/fc9745/" class="nav-link">链表</a></li><li class="dropdown-item"><!----> <a href="/pages/ad5191/" class="nav-link">树</a></li><li class="dropdown-item"><!----> <a href="/pages/6aee18/" class="nav-link">动态规划</a></li><li class="dropdown-item"><!----> <a href="/pages/78e948/" class="nav-link">排序算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><a href="/pages/0c9847/https://github.com/duochizhacai" class="link-title">GitHub</a> <span class="title" style="display:none;">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duochizhacai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/1249486902410744" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JueJin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识库" class="dropdown-title"><a href="/pages/56881f/" class="link-title">知识库</a> <span class="title" style="display:none;">知识库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/56881f/" class="nav-link">HTML</a></li><li class="dropdown-item"><!----> <a href="/pages/c0e7f0/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/pages/787250/" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/pages/f0a671/" class="nav-link">Vue</a></li><li class="dropdown-item"><!----> <a href="/pages/b7238f/" class="nav-link">React</a></li><li class="dropdown-item"><!----> <a href="/pages/2448f7/" class="nav-link">计算机网络</a></li><li class="dropdown-item"><!----> <a href="/pages/b8bd46/" class="nav-link">浏览器原理</a></li><li class="dropdown-item"><!----> <a href="/pages/f15087/" class="nav-link">性能优化</a></li><li class="dropdown-item"><!----> <a href="/pages/e3cba5/" class="nav-link">设计模式</a></li></ul></div></div><div class="nav-item"><a href="/pages/ba01c4/" class="nav-link">手写系列</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><a href="/pages/ad5191/" class="link-title">算法</a> <span class="title" style="display:none;">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8ac126/" class="nav-link">字符串</a></li><li class="dropdown-item"><!----> <a href="/pages/251490/" class="nav-link">数组</a></li><li class="dropdown-item"><!----> <a href="/pages/fc9745/" class="nav-link">链表</a></li><li class="dropdown-item"><!----> <a href="/pages/ad5191/" class="nav-link">树</a></li><li class="dropdown-item"><!----> <a href="/pages/6aee18/" class="nav-link">动态规划</a></li><li class="dropdown-item"><!----> <a href="/pages/78e948/" class="nav-link">排序算法</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><a href="/pages/0c9847/https://github.com/duochizhacai" class="link-title">GitHub</a> <span class="title" style="display:none;">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/duochizhacai" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/1249486902410744" target="_blank" rel="noopener noreferrer" class="nav-link external">
  JueJin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/pages/0c9847/" aria-current="page" class="active sidebar-link">NodeJS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/0c9847/#libuv是什么" class="sidebar-link">Libuv是什么</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#为什么node能实现单线程高并发" class="sidebar-link">为什么node能实现单线程高并发</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#node如何实现负载均衡" class="sidebar-link">Node如何实现负载均衡</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#单线程的好处" class="sidebar-link">单线程的好处</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#单线程的劣势" class="sidebar-link">单线程的劣势</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#多线程除了上下文切换之外消耗性能之外还有什么缺点" class="sidebar-link">多线程除了上下文切换之外消耗性能之外还有什么缺点</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#单线程与多线程网络后端相比有哪些好处" class="sidebar-link">单线程与多线程网络后端相比有哪些好处</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#简单说一下koa和express的区别是什么" class="sidebar-link">简单说一下koa和express的区别是什么</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#如果使用过-koa、egg-这两个-node-框架-请简述其中的中间件原理-最好用代码表示一下" class="sidebar-link">如果使用过 koa、egg 这两个 Node 框架，请简述其中的中间件原理，最好用代码表示一下</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#如何处理-node-js-中未捕获的异常" class="sidebar-link">如何处理 Node.js 中未捕获的异常</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#请简述一下-node-的多进程架构" class="sidebar-link">请简述一下 node 的多进程架构</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#master-worker架构" class="sidebar-link">Master-Worker架构</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#node如何开启多线程" class="sidebar-link">node如何开启多线程</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#worker监听同一个端口" class="sidebar-link">Worker监听同一个端口</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#请介绍一下-require-的模块加载机制" class="sidebar-link">请介绍一下 require 的模块加载机制</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#加载模块时-为什么每个模块都有-dirname-filename-属性" class="sidebar-link">加载模块时，为什么每个模块都有__dirname,__filename 属性</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#exports和module-exports的区别" class="sidebar-link">exports和module.exports的区别</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#readfile-和-createreadstream-函数有什么区别" class="sidebar-link">readFile 和 createReadStream 函数有什么区别</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#反应堆设计模式是什么" class="sidebar-link">反应堆设计模式是什么</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#process-nexttick-和-setimmediate-有什么区别" class="sidebar-link">process.nextTick 和 setImmediate 有什么区别</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#请问你知道-spawn-在创建子进程的时候-第三个参数有一个-stdio-选项吗-这个选项的作用是什么-默认的值是什么" class="sidebar-link">请问你知道 spawn 在创建子进程的时候，第三个参数有一个 stdio 选项吗，这个选项的作用是什么，默认的值是什么</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#请问实现一个-node-子进程被杀死-然后自动重启代码的思路" class="sidebar-link">请问实现一个 node 子进程被杀死，然后自动重启代码的思路</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#在上面的基础上-实现限量重启-比如我最多让其在-1-分钟内重启-5-次-超过了就报警给运维" class="sidebar-link">在上面的基础上，实现限量重启，比如我最多让其在 1 分钟内重启 5 次，超过了就报警给运维</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#新建-buffer-会占用-v8-分配的内存吗" class="sidebar-link">新建 Buffer 会占用 V8 分配的内存吗</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#buffer-alloc-和-buffer-allocunsafe-的区别" class="sidebar-link">Buffer.alloc 和 Buffer.allocUnsafe 的区别</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#介绍一下buffer-的内存分配机制" class="sidebar-link">介绍一下Buffer 的内存分配机制</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#buffer-乱码问题" class="sidebar-link">Buffer 乱码问题</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#websocket-与传统的-http-有什么优势" class="sidebar-link">webSocket 与传统的 http 有什么优势</a></li><li class="sidebar-sub-header"><a href="/pages/0c9847/#https-用哪些端口进行通信-这些端口分别有什么用" class="sidebar-link">https 用哪些端口进行通信，这些端口分别有什么用</a></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><span data-v-1cd794fe>NodeJS</span></li> <!----> <!----></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/duochizhacai" target="_blank" title="作者" class="beLink" data-v-1cd794fe>Crucials</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2022-01-27</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          NodeJS
        </h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="nodejs"><a href="#nodejs" class="header-anchor">#</a> NodeJS</h1> <h2 id="libuv是什么"><a href="#libuv是什么" class="header-anchor">#</a> <code>Libuv</code>是什么<span class="badge error" style="vertical-align:top;" data-v-d5affa18>特别重要</span></h2> <p><code>libuv</code>是一个基于事件驱动的跨平台抽象层，封装了不同操作系统一些底层特性，对外提供统一的<code>API</code>，事件循环机制也是它里面的实现,提供了跨平台，线程池，事件池，异步 <code>I/O</code> 等能力，是 <code>Node.js</code> 如此强大的关键</p> <h2 id="为什么node能实现单线程高并发"><a href="#为什么node能实现单线程高并发" class="header-anchor">#</a> 为什么<code>node</code>能实现单线程高并发<span class="badge error" style="vertical-align:top;" data-v-d5affa18>特别重要</span></h2> <p><strong>事件驱动/事件循环</strong></p> <ol><li>每个<code>Node.js</code>进程只有一个主线程在执行程序代码，形成一个<strong>执行栈</strong>（<strong><code>execution context stack</code></strong>)。</li> <li>主线程之外，还维护了一个&quot;<strong>事件队列</strong>&quot;（<code>Event queue</code>）。当用户的网络请求或者其它的异步操作到来时，<code>node</code>都会把它放到<code>Event Queue</code>之中，此时并不会立即执行它，代码也不会被阻塞，继续往下走，直到主线程代码执行完毕。</li> <li>主线程代码执行完毕完成后，然后通过<code>Event Loop</code>，也就是<strong>事件循环机制</strong>，开始到<code>Event Queue</code>的开头取出第一个事件，从<strong>线程池</strong>中分配一个线程去执行这个事件，接下来继续取出第二个事件，再从<strong>线程池</strong>中分配一个线程去执行，然后第三个，第四个。主线程不断的检查事件队列中是否有未执行的事件，直到事件队列中所有事件都执行完了，此后每当有新的事件加入到事件队列中，都会通知主线程按顺序取出交<code>EventLoop</code>处理。当有事件执行完毕后，会通知主线程，主线程执行回调，线程归还给线程池。</li> <li>主线程不断重复上面的第三步</li></ol> <h2 id="node如何实现负载均衡"><a href="#node如何实现负载均衡" class="header-anchor">#</a> <code>Node</code>如何实现负载均衡</h2> <p><code>Master</code>分发请求给<code>Worker</code>处理</p> <p>进程通信时使用到的<code>send()</code>方法，除了发送普通的对象之外，还可以用于发送 <strong><mark>句柄</mark></strong>。</p> <p>句柄是一种引用，可以用来标识资源，例如通过句柄可以标识一个 <code>socket</code> 对象、一个 <code>server</code> 对象等。利用句柄传递，可以实现请求的分发。</p> <p><code>master</code>进程创建一个<code>TCP</code>服务器监听特定端口，收到客户端的请求后，会得到一个<code>socket</code>对象，通过这个<code>socket</code>对象可以跟客户端进行通信从而处理客户端的请求。<code>master</code>进程可以通过句柄传递将该<code>socket</code>对象发送给<code>worker</code>进程，让<code>worker</code>进程去处理请求。</p> <p><img src="https://cdn.jsdelivr.net/gh/duochizhacai/generatePic/img/202203181605121.png" alt=""></p> <h2 id="单线程的好处"><a href="#单线程的好处" class="header-anchor">#</a> 单线程的好处<span class="badge error" style="vertical-align:top;" data-v-d5affa18>特别重要</span></h2> <ul><li>多线程占用内存高</li> <li>多线程间切换使得<code>CPU</code>开销大</li> <li>多线程由内存同步开销</li> <li>编写单线程程序简单</li> <li>线程安全</li></ul> <h2 id="单线程的劣势"><a href="#单线程的劣势" class="header-anchor">#</a> 单线程的劣势<span class="badge error" style="vertical-align:top;" data-v-d5affa18>特别重要</span></h2> <ul><li><code>CPU</code>密集型任务占用<code>CPU</code>时间长（可通过<code>cluster</code>方式解决）</li> <li>无法利用<code>CPU</code>的多核（可通过<code>cluster</code>方式解决）</li> <li>单线程抛出异常使得程序停止（可通过<code>try catch</code>方式或自动重启机制解决）</li></ul> <h2 id="多线程除了上下文切换之外消耗性能之外还有什么缺点"><a href="#多线程除了上下文切换之外消耗性能之外还有什么缺点" class="header-anchor">#</a> 多线程除了上下文切换之外消耗性能之外还有什么缺点<span class="badge error" style="vertical-align:top;" data-v-d5affa18>特别重要</span></h2> <p>缓存失效（<code>CPU</code>高速缓存）</p> <p>由于程序有很大概率会<strong>再次访问刚才访问过的数据</strong>，所以为了加速整个程序的运行，会使用缓存，这样我们在使用相同数据时就可以很快地获取数据。</p> <p>可一旦进行了线程调度，切换到其他线程，<code>CPU</code>就会去执行不同的代码，原有的缓存就很可能失效了，需要重新缓存新的数据，这也会造成一定的开销，所以线程调度器为了避免频繁地发生上下文切换，通常会给被调度到的线程设置最小的执行时间，也就是只有执行完这段时间之后，才可能进行下一次的调度，由此减少上下文切换的次数</p> <h2 id="单线程与多线程网络后端相比有哪些好处"><a href="#单线程与多线程网络后端相比有哪些好处" class="header-anchor">#</a> 单线程与多线程网络后端相比有哪些好处<span class="badge error" style="vertical-align:top;" data-v-d5affa18>特别重要</span></h2> <ul><li>开发人员更容易实现应用程序。我们的应用程序在生产过程中不会突然遇到意外的竞争条件。</li> <li>单线程应用程序易于扩展。</li> <li>它们可以毫不延迟地在一个时刻收到的大量用户请求提供服务。相比之下，当流量较大时，多线程后端必须等待线程池中的线程释放，才能为用户请求提供服务。利用 <code>Node.js</code> 的非阻塞特性，用户请求不会在单个线程上挂起太长时间（只有在操作不是 <code>CPU</code> 密集型时）。</li></ul> <h2 id="简单说一下koa和express的区别是什么"><a href="#简单说一下koa和express的区别是什么" class="header-anchor">#</a> 简单说一下<code>koa</code>和<code>express</code>的区别是什么</h2> <ol><li><p>写法不一样就不说了，没什么价值</p></li> <li><p>中间件的执行机制不同</p> <ul><li>在处理同步代码的时候，<code>express</code>中调用<code>next</code>与<code>koa</code>相同，都遵循洋葱圈模型，将控制权移交给下游的中间件，若在<code>req</code>上拼接了数据，当依次恢复回上游的中间件的时候，第一个中间件能够拿到所有下游中间件执行/返回的结果</li> <li>但是在下游中间件中存在异步代码例如<code>axios</code>获取数据的情况下，同样也是拼接，在<code>express</code>中第一个中间件则拿不到异步任务执行完所拼接的数据，而koa可以
<ul><li>在<code>express</code>源码中<code>next</code>函数只是单纯设置一个<code>idx</code>表示当前的中间件的索引，在<code>layer.handle_request</code>中会执行中间件的函数，里面会判断是否存在下一个中间件，待当前中间件中的函数同步代码执行完之后，立即交付给下游中间件或传递回上游中间件</li> <li><img src="https://cdn.jsdelivr.net/gh/duochizhacai/generatePic/img/202203132250002.png" alt=""></li> <li>在<code>koa-compose</code>源码中的<code>next</code>函数指派的是一个<code>dispatch</code>函数，在<code>dispatch</code>函数中返回是一个<code>Promise.resolve()</code>包裹着可以调用下一个中间件的函数，得益于利用<code>Promise</code>的异步方法，使得在<code>koa</code>中某一下游的中间件中可以使用<code>await</code>等到异步任务完成之后才能继续交付控制权</li> <li><img src="https://cdn.jsdelivr.net/gh/duochizhacai/generatePic/img/202203132244606.png" alt=""></li></ul></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 附上koa-compose 中的compose函数的核心代码</span>
<span class="token keyword">function</span> <span class="token function">compose</span> <span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// last called middleware #</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">dispatch</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'next() called multiple times'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      index <span class="token operator">=</span> i
      <span class="token keyword">let</span> fn <span class="token operator">=</span> middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> middleware<span class="token punctuation">.</span>length<span class="token punctuation">)</span> fn <span class="token operator">=</span> next
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">next</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></li></ol> <h2 id="如果使用过-koa、egg-这两个-node-框架-请简述其中的中间件原理-最好用代码表示一下"><a href="#如果使用过-koa、egg-这两个-node-框架-请简述其中的中间件原理-最好用代码表示一下" class="header-anchor">#</a> 如果使用过 <code>koa</code>、<code>egg</code> 这两个 <code>Node</code> 框架，请简述其中的中间件原理，最好用代码表示一下</h2> <p><img src="https://cdn.jsdelivr.net/gh/duochizhacai/generatePic/img/202201302253393.png" alt=""></p> <ul><li>一般的中间件都会执行两次，调用 <code>next</code> 之前为第一次，调用 <code>next</code> 时把控制传递给下游的下一个中间件。当下游不再有中间件或者没有执行 <code>next</code> 函数时，就将依次恢复上游中间件的行为，让上游中间件执行 <code>next</code> 之后的代码</li> <li>例如下面这段代码</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span>
<span class="token parameter">执行结果是<span class="token number">1</span></span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token operator">=&gt;</span><span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>koa</code> 中间件实现源码大致思路如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 注意其中的compose函数，这个函数是实现中间件洋葱模型的关键</span>
<span class="token comment">// 场景模拟</span>
<span class="token comment">// 异步 promise 模拟</span>
<span class="token keyword">const</span> <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 中间间模拟</span>
<span class="token keyword">const</span> <span class="token function-variable function">fn1</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">fn2</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">fn3</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token punctuation">[</span>fn1<span class="token punctuation">,</span> fn2<span class="token punctuation">,</span> fn3<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// compose 实现洋葱模型</span>
<span class="token keyword">const</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">middlewares<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fn <span class="token operator">=</span> middlewares<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">compose</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h2 id="如何处理-node-js-中未捕获的异常"><a href="#如何处理-node-js-中未捕获的异常" class="header-anchor">#</a> 如何处理 <code>Node.js</code> 中未捕获的异常</h2> <ul><li>我们可以在进程级别捕获应用程序中未捕获的异常。为此将侦听器附加到 <code>process</code> 全局对象：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;uncaughtException&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//打印出错误</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//打印出错误的调用栈方便调试</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>；
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li><code>Promise</code>封装异步处理，并用<code>catch</code>处理</li> <li>使用<code>pm2</code>部署项目</li></ul> <h2 id="请简述一下-node-的多进程架构"><a href="#请简述一下-node-的多进程架构" class="header-anchor">#</a> 请简述一下 <code>node</code> 的多进程架构</h2> <p>面对 <code>node</code> 单线程对多核 <code>CPU</code> 使用不足的情况，<code>Node</code> 提供了 <code>child_process</code> 模块，来实现进程的复制，<code>node</code> 的多进程架构是主从模式，如下所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/duochizhacai/generatePic/img/202201302218618" alt="图片"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var fork = require('child_process').fork;
var cpus = require('os').cpus();
for(var i = 0; i &lt; cpus.length; i++){
    fork('./worker.js');
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在 <code>linux</code> 中，我们通过 <code>ps aux | grep worker.js</code> 查看进程</p> <p><img src="https://cdn.jsdelivr.net/gh/duochizhacai/generatePic/img/202201302218928" alt="图片"></p> <p>这就是著名的主从模式，<code>Master-Worker</code></p> <h2 id="master-worker架构"><a href="#master-worker架构" class="header-anchor">#</a> <code>Master-Worker</code>架构</h2> <p><code>NodeJS</code> 提供了 <code>Child_process</code> 和 <code>Cluster</code> 模块创建子进程,实现多进程和子进程的管理.</p> <p>进程分为 <code>Master(主进程)</code>和 <code>Worker(子进程)</code>,<code>master</code>进程负责调度或管理<code>worker</code>进程，那么<code>worker</code>进程负责具体的业务处理。对于一个 <code>B/S</code> 架构的后端程序而言, <code>master</code> 就负责接受请求,然后分发给 <code>worker</code> 进程进行对应的业务处理. 多个 <code>worker</code> 就相当于多台服务器工作.也就是一个集群.同事 <code>master</code> 还负责监控 <code>worker</code> 的运行状态和管理操作</p> <h2 id="node如何开启多线程"><a href="#node如何开启多线程" class="header-anchor">#</a> <code>node</code>如何开启多线程</h2> <p><strong><code>child_process API</code></strong></p> <p><code>child_process</code> 提供了开启子进程执行代码或命令的能力,分别是:</p> <ul><li><code>spawn()</code>：启动一个子进程来执行命令</li> <li><code>exec()</code>: 启动一个子进程来执行命令，与 <code>spawn()</code>不同的是其接口不同，它有一个回调函数获知子进程的状况</li> <li><code>execFlie()</code>: 启动一个子进程来执行可执行文件</li> <li><code>fork()</code>: 与 <code>spawn()</code>类似，不同电在于它创建 <code>Node</code> 子进程需要执行 <code>js</code> 文件</li> <li><code>spawn()</code>与 <code>exec()</code>、<code>execFile()</code>不同的是，后两者创建时可以指定 <code>timeout</code> 属性设置超时时间，一旦创建的进程超过设定的时间就会被杀死</li> <li><code>exec()</code>与 <code>execFile()</code>不同的是，<code>exec()</code>适合执行已有命令，<code>execFile()</code>适合执行文件。</li></ul> <p><code>child_process.spawn()</code>、<code>child_process.fork()</code>、<code>child_process.exec()</code> 和 <code>child_process.execFile()</code> 方法都遵循其他 <code>Node.js API</code> 惯用的异步编程模式。</p> <p>每个方法都返回一个 <code>ChildProcess</code> 实例。 这些对象实现了 <code>Node.js</code> 的 <code>EventEmitter API</code>，允许父进程注册监听器函数，在子进程的生命周期中当发生某些事件时会被调用。</p> <p><code>child_process.exec()</code> 和 <code>child_process.execFile()</code> 方法还允许指定可选的 <code>callback</code> 函数，当子进程终止时会被调用。</p> <h2 id="worker监听同一个端口"><a href="#worker监听同一个端口" class="header-anchor">#</a> <code>Worker</code>监听同一个端口</h2> <p>我们之前已经实现了句柄可以发送普通对象及<code>socket</code>对象外，我们还可以通过句柄的方式发送一个<code>server</code>对象。我们在<code>master</code>进程中创建一个<code>TCP</code>服务器，将服务器对象直接发送给<code>worker</code>进程，让<code>worker</code>进程去监听端口并处理请求。因此<code>master</code>进程和<code>worker</code>进程就会监听了相同的端口了。当我们的客户端发送请求时候，我们的<code>master</code>进程和<code>worker</code>进程都可以监听到</p> <p>那么在这种模式下，主进程和<code>worker</code>进程都可以监听到相同的端口，当网络请求到来的时候，会进行抢占式调度，监听了 <code>connection</code> 事件的处理程序会抢占处理,只有一个<code>worker</code>进程会抢到链接然后进行服务，由于是抢占式调度，可以理解为谁先来谁先处理的模式，因此就不能保证每个<code>worker</code>进程都能负载均衡的问题。</p> <p>以下是一段实例的代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">|</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span> project
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">-</span>  master<span class="token punctuation">.</span>js   <span class="token comment">// 主程序入口</span>
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">-</span>  worker<span class="token punctuation">.</span>js   <span class="token comment">// 子进程</span>
<span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">--</span><span class="token operator">-</span>  client<span class="token punctuation">.</span>js   <span class="token comment">// 客户端</span>

<span class="token comment">// master.js</span>

<span class="token keyword">const</span> childProcess <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> tcpServer <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

tcpServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8089</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpus<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    childProcess<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'tcpServer'</span><span class="token punctuation">,</span> tcpServer<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// worker.js</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> tcpServer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token operator">!==</span> <span class="token string">'tcpServer'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  tcpServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello,i am </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// client.js</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpus<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  net<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    port<span class="token operator">:</span> <span class="token number">8089</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>接下来用 <code>node</code> 运行 <code>master.js</code> ,然后在运行客户端程序 <code>client.js</code> ,我们可以看到输出:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>hello,i am 5136
hello,i am 5136
hello,i am 5137
hello,i am 5135
hello,i am 5136
hello,i am 5133
hello,i am 5132
hello,i am 5137
hello,i am 5136
hello,i am 5135
hello,i am 5137
hello,i am 5133
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>可以看到的是,编号 <code>5136</code> 的 <code>worker</code> 抢占到的处理较多.</p> <h2 id="请介绍一下-require-的模块加载机制"><a href="#请介绍一下-require-的模块加载机制" class="header-anchor">#</a> 请介绍一下 <code>require</code> 的模块加载机制</h2> <ul><li>先计算模块路径</li> <li>如果模块在缓存里面，取出缓存</li> <li>如果是内置模块就直接返回</li> <li>加载模块</li> <li>输出模块的 <code>exports</code> 属性即可</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// require 其实内部调用 Module._load 方法</span>
Module<span class="token punctuation">.</span><span class="token function-variable function">_load</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> isMain</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//  计算绝对路径</span>
  <span class="token keyword">var</span> filename <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">_resolveFilename</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//  第一步：如果有缓存，取出缓存</span>
  <span class="token keyword">var</span> cachedModule <span class="token operator">=</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cachedModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

  <span class="token comment">// 第二步：是否为内置模块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>NativeModule<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> NativeModule<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/********************************这里注意了**************************/</span>
  <span class="token comment">// 第三步：生成模块实例，存入缓存</span>
  <span class="token comment">// 这里的Module就是我们上面的1.1定义的Module</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>

  <span class="token comment">/********************************这里注意了**************************/</span>
  <span class="token comment">// 第四步：加载模块</span>
  <span class="token comment">// 下面的module.load实际上是Module原型上有一个方法叫Module.prototype.load</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hadException <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hadException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> Module<span class="token punctuation">.</span>_cache<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 第五步：输出模块的exports属性</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="加载模块时-为什么每个模块都有-dirname-filename-属性"><a href="#加载模块时-为什么每个模块都有-dirname-filename-属性" class="header-anchor">#</a> 加载模块时，为什么每个模块都有<code>__dirname</code>,<code>__filename</code> 属性</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 上面的第四步module.load(filename)</span>
<span class="token comment">// 这一步，module模块相当于被包装了，包装形式如下</span>
<span class="token comment">// 加载js模块，相当于下面的代码（加载node模块和json模块逻辑不一样）</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 模块源码</span>
  <span class="token comment">// 假如模块代码如下</span>
  <span class="token keyword">var</span> math <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'math'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  exports<span class="token punctuation">.</span><span class="token function-variable function">area</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>也就是说，每个<code>module</code>里面都会传入<code>__filename</code>,<code>__dirname</code>参数，这两个参数并不是<code>module</code>本身就有的，是外界传入的</p> <h2 id="exports和module-exports的区别"><a href="#exports和module-exports的区别" class="header-anchor">#</a> <code>exports</code>和<code>module.exports</code>的区别</h2> <p>其实<code>exports.xxx = xxx</code>和<code>module.exports = {}</code>是相等的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// module.exports</span>
<span class="token comment">// hello.js</span>
<span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello, world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello, '</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    hello<span class="token operator">:</span> hello<span class="token punctuation">,</span>
    greet<span class="token operator">:</span> greet
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// exports</span>
<span class="token comment">// hello.js</span>
<span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello, world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello, '</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello, world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span>hello <span class="token operator">=</span> hello<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>greet <span class="token operator">=</span> greet<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>首先，<code>Node</code>会把整个待加载的<code>hello.js</code>文件放入一个包装函数<code>load</code>中执行。在执行这个<code>load()</code>函数前，<code>Node</code>准备好了<code>module</code>变量：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var module = {
    id: 'hello',
    exports: {}
};
load()函数最终返回module.exports：

var load = function (exports, module) {
    // hello.js的文件内容
    ...
    // load函数返回:
    return module.exports;
};

var exportes = load(module.exports, module);
也就是说，默认情况下，Node准备的exports变量和module.exports变量实际上是同一个
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="custom-block note"><p class="custom-block-title">笔记</p> <p>但是如果要输出一个函数或数组，必须直接对<code>module.exports</code>对象赋值</p> <p><code>module.exports = function () { return 'foo'; }</code></p> <p>个人觉得是因为<code>commonjs</code>的导出是浅拷贝，对于变量的话使用<code>export.x = x xx</code>的话不会引入他的模块共用同一个内存空间，但是数组和对象如果用<code>export.xxx = function() {}</code>的话会共用同一个内存空间，进而修改的时候会同时修改引用他们的所有模块</p></div> <ul><li></li></ul> <h2 id="readfile-和-createreadstream-函数有什么区别"><a href="#readfile-和-createreadstream-函数有什么区别" class="header-anchor">#</a> <code>readFile</code> 和 <code>createReadStream</code> 函数有什么区别</h2> <p><code>readFile</code> 函数异步读取文件的全部内容，并存储在内存中，然后再传递给用户。</p> <p><code>createReadStream</code> 使用一个可读的流，逐块读取文件，而不是全部存储在内存中。</p> <p>与 <code>readFile</code> 相比，<code>createReadStream</code> 使用更少的内存和更快的速度来优化文件读取操作。如果文件相当大，用户不必等待很长时间直到读取整个内容，因为读取时会先向用户发送小块内容。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">&quot;test.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="反应堆设计模式是什么"><a href="#反应堆设计模式是什么" class="header-anchor">#</a> 反应堆设计模式是什么</h2> <p>反应堆设计模式是，<code>Node.js</code> 将回调函数（处理程序）附加到每个 <code>I/O</code> 操作，然后创建请求时将处理程序提交给解复用器。</p> <p>解复用器收集应用程序中发出的每个 <code>I/O</code> 请求，并将它们作为队列中的事件进行排队。这个队列就是我们所说的事件队列。将事件排队后，解复用器返回应用程序线程的控制。</p> <p>同时，事件循环遍历事件队列中的每个事件，并调用附加的回调来处理事件响应。</p> <p>这就是 <code>Node.js</code> 中所使用的反应堆模式。</p> <h2 id="process-nexttick-和-setimmediate-有什么区别"><a href="#process-nexttick-和-setimmediate-有什么区别" class="header-anchor">#</a> <code>process.nextTick</code> 和 <code>setImmediate</code> 有什么区别</h2> <p>传递给 <code>setImmediate</code> 函数的回调将在事件队列上的下一次迭代中执行。</p> <p>另一方面，回调传递给 <code>process.nextTick</code> 在下一次迭代之前以及程序中当前运行的操作完成之后执行。在应用程序启动时，开始遍历事件队列之前调用它的回调。</p> <p>因此，回调 <code>process.nextTick</code> 总是在 <code>setImmediate</code> 之前调用。</p> <p>下面代码段：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;third&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>将按顺序输出：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>third
second
first
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="请问你知道-spawn-在创建子进程的时候-第三个参数有一个-stdio-选项吗-这个选项的作用是什么-默认的值是什么"><a href="#请问你知道-spawn-在创建子进程的时候-第三个参数有一个-stdio-选项吗-这个选项的作用是什么-默认的值是什么" class="header-anchor">#</a> 请问你知道 <code>spawn</code> 在创建子进程的时候，第三个参数有一个 <code>stdio</code> 选项吗，这个选项的作用是什么，默认的值是什么</h2> <ul><li>选项用于配置在父进程和子进程之间建立的管道。</li> <li>默认情况下，子进程的 <code>stdin</code>、 <code>stdout</code> 和 <code>stderr</code> 会被重定向到 <code>ChildProcess</code> 对象上相应的 <code>subprocess.stdin</code>、<code>subprocess.stdout</code>和 <code>subprocess.stderr</code> 流。</li> <li>这相当于将 <code>options.stdio</code> 设置为 <code>['pipe', 'pipe', 'pipe']</code></li></ul> <h2 id="请问实现一个-node-子进程被杀死-然后自动重启代码的思路"><a href="#请问实现一个-node-子进程被杀死-然后自动重启代码的思路" class="header-anchor">#</a> 请问实现一个 <code>node</code> 子进程被杀死，然后自动重启代码的思路</h2> <ul><li>在创建子进程的时候就让子进程监听 <code>exit</code> 事件，如果被杀死就重新 <code>fork</code> 一下</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">createWorker</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> worker <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'worker.js'</span><span class="token punctuation">)</span>
    worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Worker'</span> <span class="token operator">+</span> worker<span class="token punctuation">.</span>pid <span class="token operator">+</span> <span class="token string">'exited'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果退出就创建新的worker</span>
        <span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="在上面的基础上-实现限量重启-比如我最多让其在-1-分钟内重启-5-次-超过了就报警给运维"><a href="#在上面的基础上-实现限量重启-比如我最多让其在-1-分钟内重启-5-次-超过了就报警给运维" class="header-anchor">#</a> 在上面的基础上，实现限量重启，比如我最多让其在 1 分钟内重启 5 次，超过了就报警给运维</h2> <ul><li>思路大概是在创建 <code>worker</code> 的时候，就判断创建的这个 <code>worker</code> 是否在 <code>1</code> 分钟内重启次数超过 <code>5</code> 次</li> <li>所以每一次创建 <code>worker</code> 的时候都要记录这个 <code>worker</code> 创建时间，放入一个数组队列里面，每次创建 <code>worker</code> 都去取队列里前 <code>5</code> 条记录</li> <li>如果这 <code>5</code> 条记录的时间间隔小于 <code>1</code> 分钟，就说明到了报警的时候了</li></ul> <h2 id="新建-buffer-会占用-v8-分配的内存吗"><a href="#新建-buffer-会占用-v8-分配的内存吗" class="header-anchor">#</a> 新建 <code>Buffer</code> 会占用 <code>V8</code> 分配的内存吗</h2> <p>不会，<code>Buffer</code> 属于堆外内存，不是 <code>V8</code> 分配的。</p> <h2 id="buffer-alloc-和-buffer-allocunsafe-的区别"><a href="#buffer-alloc-和-buffer-allocunsafe-的区别" class="header-anchor">#</a> <code>Buffer.alloc</code> 和 <code>Buffer.allocUnsafe</code> 的区别</h2> <p><code>Buffer.allocUnsafe</code> 创建的 <code>Buffer</code> 实例的底层内存是未初始化的。新创建的 <code>Buffer</code> 的内容是未知的，可能包含敏感数据。</p> <p>使用 <code>Buffer.alloc()</code> 可以创建以零初始化的 <code>Buffer</code> 实例。</p> <h2 id="介绍一下buffer-的内存分配机制"><a href="#介绍一下buffer-的内存分配机制" class="header-anchor">#</a> 介绍一下<code>Buffer</code> 的内存分配机制</h2> <p>为了高效的使用申请来的内存，<code>Node</code> 采用了 <code>slab</code> 分配机制。</p> <p><code>slab</code> 是一种动态的内存管理机制。<code>Node</code> 以 <code>8kb</code> 为界限来来区分 <code>Buffer</code> 为大对象还是小对象，如果是小于 <code>8kb</code> 就是小 <code>Buffer</code>，大于 <code>8kb</code> 就是大 <code>Buffer</code>。</p> <p>例如第一次分配一个 <code>1024</code> 字节的 <code>Buffer</code>，<code>Buffer.alloc(1024)</code>,那么这次分配就会用到一个 <code>slab</code>，接着如果继续 <code>Buffer.alloc(1024)</code>,那么上一次用的 <code>slab</code> 的空间还没有用完，因为总共是 <code>8kb</code>，<code>1024+1024 = 2048 个字节</code>，没有 <code>8kb</code>，所以就继续用这个 <code>slab</code> 给 <code>Buffer</code> 分配空间。如果超过 <code>8kb</code>，那么直接用 <code>C++</code>底层地宫的 <code>SlowBuffer</code> 来给 <code>Buffer</code> 对象提供空间</p> <h2 id="buffer-乱码问题"><a href="#buffer-乱码问题" class="header-anchor">#</a> Buffer 乱码问题</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>// test.md
床前明月光，疑是地上霜，举头望明月，低头思故乡
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们这样读取就会出现乱码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'test.md'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>highWaterMark<span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 床前明???光，疑???地上霜，举头???明月，???头思故乡</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>一般情况下，只需要设置 <code>rs.setEncoding('utf8')</code>即可解决乱码问题</p> <h2 id="websocket-与传统的-http-有什么优势"><a href="#websocket-与传统的-http-有什么优势" class="header-anchor">#</a> <code>webSocket</code> 与传统的 <code>http</code> 有什么优势</h2> <ul><li>客户端与服务器只需要一个 <code>TCP</code> 连接，比 <code>http</code> 长轮询使用更少的连接</li> <li><code>webSocket</code> 服务端可以推送数据到客户端</li> <li>更轻量的协议头，减少数据传输量</li></ul> <h2 id="https-用哪些端口进行通信-这些端口分别有什么用"><a href="#https-用哪些端口进行通信-这些端口分别有什么用" class="header-anchor">#</a> <code>https</code> 用哪些端口进行通信，这些端口分别有什么用</h2> <ul><li><code>443</code> 端口用来验证服务器端和客户端的身份，比如验证证书的合法性</li> <li><code>80</code> 端口用来传输数据（在验证身份合法的情况下，用来数据传输）</li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/03/20, 19:40:28</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="https://github.com/duochizhacai" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://juejin.cn/user/1249486902410744" title="JueJin" target="_blank" class="iconfont icon-juejin"></a></div> 
    Copyright © 2021-2022
    <span><a href='https://beian.miit.gov.cn'>粤ICP备2021165371号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.95fc12d6.js" defer></script><script src="/assets/js/2.abf57e2f.js" defer></script><script src="/assets/js/80.6c258060.js" defer></script><script src="/assets/js/3.e687237e.js" defer></script>
  </body>
</html>
